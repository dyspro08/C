import{initializeApp}from"https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";import{getAuth,GoogleAuthProvider,signInWithPopup,signOut,onAuthStateChanged}from"https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";import{getFirestore,collection,addDoc,query,orderBy,onSnapshot,serverTimestamp,setDoc,doc,getDoc,updateDoc,arrayUnion,arrayRemove,where,getDocs,deleteDoc,enableIndexedDbPersistence,limit,writeBatch}from"https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";const firebaseConfig={apiKey:"AIzaSyBw2TJjZYZZPd1piCeoFnAXhqEAcCLe1FE",authDomain:"chat-7e64b.firebaseapp.com",projectId:"chat-7e64b",storageBucket:"chat-7e64b.firebasestorage.app",messagingSenderId:"1094029259482",appId:"1:1094029259482:web:992007326706c5f6bd6be3",measurementId:"G-QMTLBH6TX0"},app=initializeApp(firebaseConfig),auth=getAuth(app),db=getFirestore(app);try{enableIndexedDbPersistence(db).catch(()=>{})}catch(e){}const IMGBB_API_KEY="ba55d8996626ae2a418e0374ff993157";let currentUser=null,currentChatId=null,currentPostId=null,contextMenuServerId=null,unsubscribeMessages=null,unsubscribePosts=null,unsubscribeComments=null,unsubscribeChatList=null,unsubscribeServerList=null,cachedUserList=null,lastMessageTime=0;const getEl=e=>document.getElementById(e);async function handleLogin(){try{await signInWithPopup(auth,new GoogleAuthProvider)}catch(e){alert("ë¡œê·¸ì¸ ì˜¤ë¥˜: "+e.message)}}function openSettings(){currentUser&&(getEl("settingAvatar").src=currentUser.photoURL,getEl("settingName").textContent=currentUser.displayName,getEl("settingEmail").textContent=currentUser.email,getEl("settingsModal").style.display="flex")}function resetActiveIcons(){document.querySelectorAll(".server-icon").forEach(e=>e.classList.remove("active")),document.querySelectorAll(".dm-item").forEach(e=>e.classList.remove("active"))}function showHomeView(){resetActiveIcons(),getEl("homeBtn").classList.add("active"),getEl("homeView").style.display="flex",getEl("chatView").style.display="none",getEl("communityView").style.display="none",getEl("mainHeaderTitle").textContent="í™ˆ",getEl("mainHeaderIcon").className="fas fa-home",getEl("sidebarTitle").textContent="ëŒ€í™”",getEl("inviteBtn").style.display="none",currentChatId=null,document.title="Chat App",unsubscribeMessages&&(unsubscribeMessages(),unsubscribeMessages=null),unsubscribePosts&&(unsubscribePosts(),unsubscribePosts=null),getEl("sidebarContent").innerHTML='<div class="channel-category">ë¡œë”© ì¤‘...</div>',loadRecentChats(),loadAllUsers()}function showCommunityView(){resetActiveIcons(),getEl("communityBtn").classList.add("active"),getEl("homeView").style.display="none",getEl("chatView").style.display="none",getEl("communityView").style.display="flex",currentChatId=null,document.title="Chat App",unsubscribeMessages&&(unsubscribeMessages(),unsubscribeMessages=null),unsubscribeChatList&&(unsubscribeChatList(),unsubscribeChatList=null),getEl("postListSection").style.display="flex",getEl("postWriteSection").style.display="none",getEl("postDetailSection").style.display="none",getEl("mainHeaderTitle").textContent="ììœ ê²Œì‹œíŒ",getEl("sidebarTitle").textContent="ì»¤ë®¤ë‹ˆí‹°",getEl("inviteBtn").style.display="none",getEl("sidebarContent").innerHTML='<div class="channel-category">ê²Œì‹œíŒ</div><div class="dm-item active"><i class="fas fa-list"></i> ììœ ê²Œì‹œíŒ</div>',loadCommunityPosts()}function loadMyServers(){if(!currentUser)return;unsubscribeServerList&&unsubscribeServerList();const e=query(collection(db,"servers"),where("members","array-contains",currentUser.uid));unsubscribeServerList=onSnapshot(e,e=>{const t=getEl("serverListContainer");t.innerHTML="",e.forEach(e=>{const s=e.data(),n=document.createElement("div");n.className="server-icon",n.textContent=s.name.substring(0,1),n.id=`server_icon_${e.id}`;const a=s.lastMessageTime?.toDate()?.getTime()||0,i=s[`lastRead_${currentUser.uid}`]?.toDate()?.getTime()||0,r=s.lastMessageSenderId||"",c=a>i&&r!==currentUser.uid,o=currentChatId===e.id;if(c&&!o){const e=document.createElement("span");e.className="unread-badge",n.appendChild(e)}o&&n.classList.add("active"),n.onclick=t=>{resetActiveIcons(),n.classList.add("active");const a=n.querySelector(".unread-badge");a&&a.remove(),enterServerChat(e.id,s.name)},n.oncontextmenu=t=>{t.preventDefault(),contextMenuServerId=e.id;const s=getEl("serverContextMenu");s.style.display="block",s.style.left=`${t.pageX}px`,s.style.top=`${t.pageY}px`},t.appendChild(n)})})}function loadRecentChats(){if(!currentUser)return;unsubscribeChatList&&unsubscribeChatList();const e=getEl("sidebarContent"),t=query(collection(db,"chats"),where("members","array-contains",currentUser.uid),orderBy("lastMessageTime","desc"));unsubscribeChatList=onSnapshot(t,t=>{if("ëŒ€í™”"!==getEl("sidebarTitle").textContent)return;let s='<div class="channel-category">ìµœê·¼ ëŒ€í™”</div>';t.forEach(e=>{const t=e.data(),n=e.id;let a={displayName:"ì•Œ ìˆ˜ ì—†ìŒ",photoURL:""};if(!t.participantData)return;{const e=Object.keys(t.participantData).find(e=>e!==currentUser.uid);e&&(a=t.participantData[e])}const i=t.lastMessageTime?.toDate()?.getTime()||0,r=t[`lastRead_${currentUser.uid}`]?.toDate()?.getTime()||0,c=t.lastMessageSenderId||"",o=i>r&&c!==currentUser.uid,l=currentChatId===n,d=o&&!l;s+=`\n            <div class="dm-item ${l?"active":""}" id="chat_item_${n}">\n                <img src="${a.photoURL||"https://via.placeholder.com/32"}">\n                <span class="name">${a.displayName}</span>\n                ${d?'<span class="unread-badge"></span>':""} \n            </div>`}),e.innerHTML=s,t.forEach(e=>{const t=e.id,s=e.data();let n=null;if(s.participantData){const e=Object.keys(s.participantData).find(e=>e!==currentUser.uid);e&&(n={uid:e,...s.participantData[e]})}const a=getEl(`chat_item_${t}`);a&&(a.onclick=()=>{const e=a.querySelector(".unread-badge");e&&e.remove(),n&&startDM(n)})})})}function enterServerChat(e,t){currentChatId=e,document.title=t,getEl("homeView").style.display="none",getEl("communityView").style.display="none",getEl("chatView").style.display="flex",getEl("mainHeaderTitle").textContent=t,getEl("mainHeaderIcon").className="fas fa-users",getEl("sidebarTitle").textContent=t,getEl("inviteBtn").style.display="block",unsubscribeChatList&&(unsubscribeChatList(),unsubscribeChatList=null),getEl("sidebarContent").innerHTML='<div class="channel-category">ì±„ë„</div><div class="dm-item active"><i class="fas fa-hashtag"></i> ì¼ë°˜</div>',unsubscribePosts&&(unsubscribePosts(),unsubscribePosts=null),loadMessages(e),markAsRead(e,!0)}async function startDM(e){const t=[currentUser.uid,e.uid].sort(),s=`dm_${t[0]}_${t[1]}`,n=doc(db,"chats",s);(await getDoc(n)).exists()||await setDoc(n,{members:t,participantData:{[currentUser.uid]:{displayName:currentUser.displayName,photoURL:currentUser.photoURL},[e.uid]:{displayName:e.displayName,photoURL:e.photoURL}},createdAt:serverTimestamp(),lastMessageTime:serverTimestamp(),lastMessageSenderId:currentUser.uid,[`lastRead_${currentUser.uid}`]:serverTimestamp(),[`lastRead_${e.uid}`]:serverTimestamp()}),resetActiveIcons(),getEl("homeBtn").classList.add("active"),getEl("homeView").style.display="none",getEl("communityView").style.display="none",getEl("chatView").style.display="flex",currentChatId=s,document.title=e.displayName,getEl("mainHeaderTitle").textContent=e.displayName,getEl("mainHeaderIcon").className="fas fa-user",getEl("inviteBtn").style.display="none",getEl("sidebarTitle").textContent="ëŒ€í™”",unsubscribePosts&&(unsubscribePosts(),unsubscribePosts=null),loadMessages(s),markAsRead(s,!1)}async function markAsRead(e,t=!1){if(!currentUser||!e)return;const s={[`lastRead_${currentUser.uid}`]:serverTimestamp()};try{t?await updateDoc(doc(db,"servers",e),s):await updateDoc(doc(db,"chats",e),s)}catch(e){console.log("ì½ìŒ ì²˜ë¦¬ ì‹¤íŒ¨")}}async function leaveServerFromContext(){if(contextMenuServerId&&currentUser&&confirm("ì„œë²„ì—ì„œ ë‚˜ê°€ì‹œê² ìŠµë‹ˆê¹Œ?"))try{await updateDoc(doc(db,"servers",contextMenuServerId),{members:arrayRemove(currentUser.uid)}),currentChatId===contextMenuServerId&&showHomeView(),alert("ë‚˜ê°”ìŠµë‹ˆë‹¤.")}catch(e){alert("ì˜¤ë¥˜: "+e.message)}}async function createServer(){const e=getEl("newServerName").value.trim();e&&(await addDoc(collection(db,"servers"),{name:e,owner:currentUser.uid,members:[currentUser.uid],createdAt:serverTimestamp(),lastMessageTime:serverTimestamp(),lastMessageSenderId:currentUser.uid,[`lastRead_${currentUser.uid}`]:serverTimestamp()}),getEl("serverModal").style.display="none")}async function joinServer(){const e=getEl("joinServerCode").value.trim();if(!e)return;const t=doc(db,"servers",e);(await getDoc(t)).exists()&&(await updateDoc(t,{members:arrayUnion(currentUser.uid)}),getEl("serverModal").style.display="none")}function handlePasteUpload(e){const t=(e.clipboardData||e.originalEvent.clipboardData).items;for(let s in t){const n=t[s];if("file"===n.kind&&n.type.includes("image"))return processAndUploadImage(n.getAsFile()),void e.preventDefault()}}async function processAndUploadImage(e){if(!currentUser||!currentChatId)return;const t=getEl("sendMsgBtn"),s=t.innerHTML;t.innerHTML='<i class="fas fa-spinner fa-spin"></i>',t.disabled=!0;try{const t=await uploadToImgBB(e);t&&await sendMessage(null,t)}catch(e){console.log(e)}t.innerHTML=s,t.disabled=!1,getEl("imageInput").value=""}async function uploadToImgBB(e){const t=new FormData;t.append("image",e);const s=await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_API_KEY}&expiration=86400`,{method:"POST",body:t}),n=await s.json();return n.success?n.data.url:null}async function sendMessage(e=null,t=null){const s=getEl("messageInput"),n=null!==e?e:s.value.trim();if(!n&&!t||!currentChatId)return;if(n.length>200)return void alert("200ì ì œí•œ");const a=Date.now();if(a-lastMessageTime<1e3)return;lastMessageTime=a;const i={text:n||"",imageUrl:t||null,uid:currentUser.uid,displayName:currentUser.displayName,photoURL:currentUser.photoURL,createdAt:serverTimestamp()};try{const e=writeBatch(db),n=doc(collection(db,"chats",currentChatId,"messages"));e.set(n,i);if(!currentChatId.startsWith("dm_")){const t=doc(db,"servers",currentChatId);e.update(t,{lastMessageTime:serverTimestamp(),lastMessageSenderId:currentUser.uid,[`lastRead_${currentUser.uid}`]:serverTimestamp()})}else{const t=doc(db,"chats",currentChatId);e.set(t,{lastMessageTime:serverTimestamp(),lastMessageSenderId:currentUser.uid,[`lastRead_${currentUser.uid}`]:serverTimestamp(),members:arrayUnion(currentUser.uid)},{merge:!0})}await e.commit(),t||(s.value="")}catch(e){console.error("ì „ì†¡ ì‹¤íŒ¨:",e),"not-found"===e.code&&alert("ì±„íŒ…ë°© ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")}}function loadMessages(e){unsubscribeMessages&&unsubscribeMessages();const t=getEl("messagesContainer");t.innerHTML="";const s=query(collection(db,"chats",e,"messages"),orderBy("createdAt","asc"),limit(75));unsubscribeMessages=onSnapshot(s,s=>{s.docChanges().forEach(s=>{if("added"===s.type){const n=s.doc.data(),a=n.uid===currentUser.uid;let i="";if(n.createdAt){i=(n.createdAt.toDate?n.createdAt.toDate():new Date).toLocaleTimeString("ko-KR",{hour:"2-digit",minute:"2-digit"})}if(!a&&document.hidden&&(document.title="ğŸ”´ ìƒˆ ë©”ì‹œì§€!"),!document.hidden&&currentChatId===e){const t=!e.startsWith("dm_");markAsRead(e,t)}let r="";n.imageUrl&&(r+=`<img src="${n.imageUrl}" class="chat-image" onclick="window.open(this.src)">`),n.text&&(r+=`<div>${n.text}</div>`);const c=document.createElement("div");c.className="message-wrapper "+(a?"me":"other"),c.innerHTML=a?`<span class="msg-time">${i}</span><div class="bubble">${r}</div>`:`<img src="${n.photoURL}" class="avatar">\n                       <div class="bubble-group">\n                           <span class="meta">${n.displayName}</span>\n                           <div style="display:flex; align-items:flex-end;">\n                               <div class="bubble">${r}</div>\n                               <span class="msg-time">${i}</span>\n                           </div>\n                       </div>`,t.appendChild(c)}}),t.scrollTop=t.scrollHeight})}function loadCommunityPosts(){unsubscribePosts&&unsubscribePosts();const e=getEl("postsContainer"),t=query(collection(db,"posts"),orderBy("createdAt","desc"),limit(50));unsubscribePosts=onSnapshot(t,t=>{e.innerHTML="",t.empty&&(e.innerHTML='<div style="color:#72767d; text-align:center;">ì‘ì„±ëœ ê¸€ì´ ì—†ìŠµë‹ˆë‹¤.</div>'),t.forEach(t=>{const s=t.data(),n=s.createdAt?new Date(1e3*s.createdAt.seconds).toLocaleDateString():"",a=document.createElement("div");a.className="post-item",a.innerHTML=`<h3>${s.title}</h3><div class="post-info"><span>${s.authorName}</span> â€¢ <span>${n}</span></div>`,a.onclick=()=>showPostDetail(t.id,s),e.appendChild(a)})})}function showWriteForm(){getEl("postListSection").style.display="none",getEl("postWriteSection").style.display="flex",getEl("postTitleInput").value="",getEl("postContentInput").value=""}async function submitPost(){const e=getEl("postTitleInput").value.trim(),t=getEl("postContentInput").value.trim();e&&t&&(await addDoc(collection(db,"posts"),{title:e,content:t,authorUid:currentUser.uid,authorName:currentUser.displayName,createdAt:serverTimestamp()}),showCommunityView())}function showPostDetail(e,t){currentPostId=e,getEl("postListSection").style.display="none",getEl("postDetailSection").style.display="flex",getEl("detailTitle").textContent=t.title,getEl("detailAuthor").textContent=t.authorName,getEl("detailContent").textContent=t.content,getEl("detailDate").textContent=t.createdAt?new Date(1e3*t.createdAt.seconds).toLocaleString():"",loadComments(e)}function loadComments(e){unsubscribeComments&&unsubscribeComments();const t=getEl("commentsContainer"),s=query(collection(db,"posts",e,"comments"),orderBy("createdAt","asc"),limit(100));unsubscribeComments=onSnapshot(s,e=>{t.innerHTML="",e.forEach(e=>{const s=e.data(),n=document.createElement("div");n.className="comment-item",n.innerHTML=`<div class="comment-header">${s.authorName}</div><div>${s.text}</div>`,t.appendChild(n)})})}async function submitComment(){const e=getEl("commentInput").value.trim();e&&currentPostId&&(await addDoc(collection(db,"posts",currentPostId,"comments"),{text:e,authorName:currentUser.displayName,uid:currentUser.uid,createdAt:serverTimestamp()}),getEl("commentInput").value="")}async function loadAllUsers(){getEl("userListContainer");if(cachedUserList)return void renderUserList(cachedUserList);const e=query(collection(db,"users")),t=await getDocs(e);cachedUserList=[],t.forEach(e=>cachedUserList.push(e.data())),renderUserList(cachedUserList)}function renderUserList(e){const t=getEl("userListContainer");t.innerHTML="";let s=0;e.forEach(e=>{if(e.uid===currentUser.uid)return;s++;const n=document.createElement("div");n.className="user-card",n.innerHTML=`<img src="${e.photoURL}"><div><h4>${e.displayName}</h4></div>`,n.onclick=()=>startDM(e),t.appendChild(n)}),getEl("userCount").textContent=s}function handleSearch(e){const t=e.target.value.toLowerCase();document.querySelectorAll(".user-card").forEach(e=>e.style.display=e.innerText.toLowerCase().includes(t)?"flex":"none")}window.addEventListener("focus",()=>{if(document.title="Chat App",currentChatId){const e=!currentChatId.startsWith("dm_");markAsRead(currentChatId,e)}}),document.addEventListener("DOMContentLoaded",()=>{getEl("googleLoginBtn")?.addEventListener("click",handleLogin),getEl("settingsBtn")?.addEventListener("click",openSettings),getEl("closeSettingsBtn")?.addEventListener("click",()=>getEl("settingsModal").style.display="none"),getEl("modalLogoutBtn")?.addEventListener("click",()=>{signOut(auth),getEl("settingsModal").style.display="none"}),document.addEventListener("click",()=>{getEl("serverContextMenu").style.display="none",document.title="Chat App"}),getEl("contextLeaveServer")?.addEventListener("click",()=>leaveServerFromContext()),getEl("contextCopyId")?.addEventListener("click",()=>{contextMenuServerId&&(navigator.clipboard.writeText(contextMenuServerId),alert("ID ë³µì‚¬ë¨"))}),getEl("homeBtn")?.addEventListener("click",showHomeView),getEl("communityBtn")?.addEventListener("click",showCommunityView),getEl("addServerBtn")?.addEventListener("click",()=>getEl("serverModal").style.display="flex"),getEl("closeModalBtn")?.addEventListener("click",()=>getEl("serverModal").style.display="none"),getEl("createServerBtn")?.addEventListener("click",createServer),getEl("joinServerBtn")?.addEventListener("click",joinServer),getEl("inviteBtn")?.addEventListener("click",()=>navigator.clipboard.writeText(currentChatId).then(()=>alert("ì´ˆëŒ€ ì½”ë“œ ë³µì‚¬ë¨"))),getEl("sendMsgBtn")?.addEventListener("click",()=>sendMessage()),getEl("messageInput")?.addEventListener("keypress",e=>{"Enter"===e.key&&sendMessage()}),getEl("messageInput")?.addEventListener("paste",handlePasteUpload),getEl("attachBtn")?.addEventListener("click",()=>getEl("imageInput").click()),getEl("imageInput")?.addEventListener("change",e=>{e.target.files[0]&&processAndUploadImage(e.target.files[0])}),getEl("writePostBtn")?.addEventListener("click",showWriteForm),getEl("cancelPostBtn")?.addEventListener("click",()=>{getEl("postWriteSection").style.display="none",getEl("postListSection").style.display="flex"}),getEl("submitPostBtn")?.addEventListener("click",submitPost),getEl("backToListBtn")?.addEventListener("click",showCommunityView),getEl("submitCommentBtn")?.addEventListener("click",submitComment),getEl("userSearchInput")?.addEventListener("input",handleSearch)}),onAuthStateChanged(auth,async e=>{if(e){let t=e.displayName;"yudongyun08@gmail.com"===e.email&&(t="ê´€ë¦¬ì"),currentUser={...e,displayName:t},getEl("loginOverlay").style.display="none",getEl("myAvatar").src=e.photoURL,getEl("myName").textContent=t,await setDoc(doc(db,"users",e.uid),{uid:e.uid,displayName:t,email:e.email,photoURL:e.photoURL,lastLogin:serverTimestamp()},{merge:!0}),loadMyServers(),showHomeView()}else currentUser=null,cachedUserList=null,getEl("loginOverlay").style.display="flex",unsubscribeChatList&&unsubscribeChatList(),unsubscribeServerList&&unsubscribeServerList(),unsubscribeMessages&&unsubscribeMessages()});
